<!DOCTYPE html>
  <html>
    <head>
      <meta charset="utf-8" />
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
      <!-- JCROP -->
      <link rel="stylesheet" href="css/Jcrop.css" type="text/css" />
      <link type="text/css" rel="stylesheet" href="css/estilo.css" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
      <title>COSTOX</title>
    </head>
    <body>
      <header>
        <nav class="blue z-depth-1">
          <div class="nav-wrapper container">
            <a href="index.html" class="brand-logo"><img src="images/logo-labmol.png" alt="Logo LabMol"/></a>
            <a href="#" data-activates="menu-mobile" class="button-collapse waves-effect"><i class="material-icons">menu</i></a>
            <ul class="right hide-on-med-and-down">
              <!-- <li><a href="sass.html">Sass</a></li>
              <li><a href="badges.html">Components</a></li> -->
              <li><a id="displayName" class="dropdown-button waves-effect truncate" data-beloworigin="true"
                data-hover="true" data-constrainwidth="true" data-activates="dropdownLogin">
                <!-- PREENCHIDO COM JAVA SCRIPT -->
              </a></li>
            </ul>

            <!-- MENU MOBILE -->
             <ul class="side-nav" id="menu-mobile">
              <li id="displayNameMobileLogado"></li>
              <li><a id="displayNameMobile"  class="dropdown-button waves-effect" data-beloworigin="false" data-activates="dropdownLogin2"></a></li>
              <!-- <li><a href="sass.html">Sass</a></li>
              <li><a href="badges.html">Components</a></li> -->
              <li class="divider"></li>
              <li class="waves-effect" id="btnSairMobile" style="display: none"><a onclick="logout()">Sair</a></li>
            </ul>
          </div>
        </nav>
        <!-- Dados do menu dropdown -->
        <ul id="dropdownLogin" class="dropdown-content">
          <li><a class="waves-effect" onclick="loginGoogle()"><img src="icons/google.svg">Google</a></li>
          <li><a class="waves-effect" onclick="loginFacebook()"><img src="icons/facebook.svg">Facebook</a></li>
          <li style="display: none"><a class="waves-effect" onclick="logout()">Sair</a></li>
        </ul>
        <!-- Dados do menu dropdown mobile-->
        <ul id="dropdownLogin2" class="dropdown-content">
          <li><a onclick="loginGoogle()"><img src="icons/google.svg">Google</a></li>
          <li><a onclick="loginFacebook()"><img src="icons/facebook.svg">Facebook</a></li>
        </ul>
      </header>
      <section id="main" class="container">

        <div class="row">
          <div class="col offset-m2"></div>
          <div class="col s12 m4" id="div_take_picture">
              <div class="card red z-depth-1 hoverable">
                <div class="card-content black-text">
                  <center><i class="large material-icons">camera_alt</i></center>
                  <span class="card-title">Take Your Picture</span>
                  <p></p>
                </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card yellow accent-3 z-depth-1 hoverable">
              <label for="file_up">
                <div class="card-content black-text">
                  <center><i class="large material-icons">file_upload</i></center>
                  <span class="card-title">Upload Your Photo</span>
                  <input id="file_up" name="fileUp" style="display:none"
                  type="file" accept="image/png, image/jpeg, capture=camera" />
                </div>
              </label>
            </div>
          </div>

          <div id="div_crop" class="col s12 m12" style="display: none">
            <center>
              <img id="img_crop" class="responsive-img" src="" />
              <a onclick="reload();" class="waves-effect waves-red red-text btn-flat" style="margin-top: 10px;">BACK</a>
              <a id="btnCrop" class="blue waves-effect waves-light btn"  style="margin-top: 10px;">CROP</a>
            </center>
          </div>

          <div id="div_take" class="col s12 m12" style="display: none">
            <center>
              <video class="responsive-video" autoplay></video>
              <canvas style="display: none"></canvas>
            </center>
            <center>
              <a onclick="reload();" class="waves-effect waves-red red-text btn-flat" style="margin-top: 10px;">BACK</a>
              <a id="btnTake" class="blue waves-effect waves-light btn" style="margin-top: 10px;">TAKE</a>
            </center>
          </div>

        </div>

        <!-- ESTRUTURA DO MODAL -->
        <div id="modalErro" class="modal">
          <div class="modal-content">
            <h4 class="red-text">Erro!</h4>
            <p id="#messageModalErro"></p>
          </div>
          <div class="modal-footer">
            <a class="modal-action modal-close waves-effect waves-red btn-flat red-text">Fechar</a>
          </div>
        </div>

      </section>

      <footer class="blue page-footer">
          <div class="container">
            <div class="row">
              <div class="col l8 s12">
                <h5 class="white-text">LabMol</h5>
                <p class="grey-text text-lighten-4">The Laboratory for Molecular Modeling and Drug Design was established in March 2009, at the Faculty of Pharmacy of the Federal University of Goiás. Our research group is focused on designing of new drug candidates for infectious diseases such as Chagas disease, schistosomiasis, leishmaniasis, malaria and tuberculosis, as well as for cancer. Another important goal of our group is the development of predictive models for pharmacokinetics and toxicity properties. The work developed by our group has resulted in publications in international indexed journals, abstracts, dissertations and awards in national and international meetings of Medicinal and Computational Chemistry area.</p>
              </div>
              <div class="col l2 offset-l2 s12">
                <h5 class="white-text">Links</h5>
                <ul>
                  <li><a class="grey-text text-lighten-3" href="#!">Link 1</a></li>
                  <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
                  <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
                  <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="footer-copyright">
            <div class="container">
            © 2017 Copyright
            <a class="grey-text text-lighten-4 right" href="#!">More Links</a>
            </div>
          </div>
        </footer>


      <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
      <script type="text/javascript" src="js/materialize.min.js"></script>
      <script src="js/Jcrop.js"></script>

      <!-- FIREBASE -->
      <script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
      <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/4.2.0/firebase-auth.js"></script>

      <script>
        var pathFile;

        //EFETUA O UPLOAD DA IMAGEM
        $("#file_up").change(function(event) {
          var form = new FormData();
          form.append('fileUp', event.target.files[0]);

          $.ajax({
            url: "upload.php",
            data: form,
            processData: false,
            contentType: false,
            type: 'POST',
            success: function (data) {
              pathFile = data;
              console.log(pathFile);

              hideCards();
              showImage(pathFile);
            }
          });
        });

        $('#div_take_picture').click(function(event){
          var video = document.querySelector('video');
          var canvas = document.querySelector('canvas');
          var div = document.querySelector("#div_take");
          var localMediaStream = null;

          hideCards();
          div.style = "display: block";

          navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
          window.URL = window.URL || window.webkitURL;

          navigator.getUserMedia({video : true}, function(stream) {
              video.src = window.URL.createObjectURL(stream);
              localMediaStream = stream;

              localMediaStream.stop = function(){
                this.getVideoTracks().forEach(function(track){
                  track.stop();
                });
              }
            }, function(){
              alert("Erro ao acessar a câmera!")
            });

            $('#btnTake').click(function(event){
              if (localMediaStream) {
                var width = video.offsetWidth, height = video.offsetHeight;
                var context;

                canvas.width = width;
                canvas.height = height;

                context = canvas.getContext("2d");
                context.drawImage(video, 0, 0, width, height);
                //img.src = canvas.toDataURL('image/png');

                div.style = "display: none";
                showImage(canvas.toDataURL('image/png'));

                //UPLOAD DA IMAGEM CAPTURADA
                var form = new FormData();
                form.append('fileUp', canvas.toDataURL('image/png'));

                $.ajax({
                  url: "upload.php",
                  data: form,
                  processData: false,
                  contentType: false,
                  type: 'POST',
                  success: function (data) {
                    pathFile = data;
                    console.log(pathFile);
                  }
                });

                localMediaStream.stop();
                video.src = "";
              }
            });
        });

        $('#btnCrop').click(function(e){
          var canvas = document.querySelector('canvas');

          //PROCESSAR COM TESSERACT
          var form = new FormData();
          form.append('pathFile', pathFile);

          $.ajax({
            url: "tesseract.php",
            data: form,
            processData: false,
            contentType: false,
            type: 'POST',
            success: function (data) {
              console.log(data);
            }
          });
        });

        function reload(){
            window.location.reload();
        };

        function hideCards(){
          var cards = $('.card');
          cards[0].style = "display: none";
          cards[1].style = "display: none";
        }

        function showImage(pathImage){
          document.getElementById("div_crop").style = "display : block";

          var img = document.getElementById("img_crop");
          img.src = pathImage;
          $('#img_crop').Jcrop();
        }
      </script>
      <script>
        //INICIALIZAR MENU MOBILE
        $(".button-collapse").sideNav();
        //INICIALIZAR MODAL
        $('.modal').modal();

        // Initialize Firebase
        var config = {
          apiKey: "AIzaSyB8DNlYFz20FGf-fUiK6CFYV5ebMRZSc7U",
          authDomain: "costox-br.firebaseapp.com",
          databaseURL: "https://costox-br.firebaseio.com",
          projectId: "costox-br",
          storageBucket: "costox-br.appspot.com",
          messagingSenderId: "512966491595"
        };
        firebase.initializeApp(config);

          firebase.auth().onAuthStateChanged(function(user) {
            if(user){
              console.log("Logado");
              // Materialize.toast("Toast teste", 4000);
              setNameDisplay(user.displayName, user.photoURL);

              var lis = document.getElementById('dropdownLogin').getElementsByTagName("li");
              lis[0].style.display = "none";
              lis[1].style.display = "none";
              lis[2].style.display = "block";
              //PARA O MENU MOBILE
              lis = document.getElementById('dropdownLogin2').getElementsByTagName("li");
              lis[0].style.display = "none";
              lis[1].style.display = "none";
              document.getElementById("btnSairMobile").style.display = "block";

              // if (user.emailVerified) {
              //     // User is signed in
              //     var email = user.email;
              //     alert("logado: " + email);
              //
              // } else {
              //     // User is not signed in
              //     alert("Verifique o email para continuar!");
              // }
            } else {
              console.log("Não logado");
              setNameDisplay("Login", "");

              var lis = document.getElementById('dropdownLogin').getElementsByTagName("li");
              lis[0].style.display = "block";
              lis[1].style.display = "block";
              lis[2].style.display = "none";
              //PARA MENU MOBILE
              lis = document.getElementById('dropdownLogin2').getElementsByTagName("li");
              lis[0].style.display = "block";
              lis[1].style.display = "block";
              document.getElementById("btnSairMobile").style.display = "none";
            }
          });

        // LOGAR COM A CONTA DO GOOGLE
        function loginGoogle(){
          var provider = new firebase.auth.GoogleAuthProvider();
          //provider.addScope('https://www.googleapis.com/auth/contacts.readonly');
          // firebase.auth().useDeviceLanguage();

          firebase.auth().signInWithPopup(provider).then(function(result) {
            var token = result.credential.accessToken;
            var user = result.user;

          }).catch(function(error) {
            var errorCode = error.code;
            var errorMessage = error.message;

            showModalMessageError(errorCode);
            console.error(errorCode);
            console.error(errorMessage);
          });
        }

        // LOGAR COM A CONTA DO FACEBOOK
        function loginFacebook(){
          console.log("loginFacebook()");
          var provider = new firebase.auth.FacebookAuthProvider();
          provider.setCustomParameters({
            'display': 'popup'
          });
          //firebase.auth().useDeviceLanguage();

          firebase.auth().signInWithPopup(provider).then(function(result) {
            var token = result.credential.accessToken;
            var user = result.user;

            console.log(user.displayName + token);
          }).catch(function(error) {
            var errorCode = error.code;
            var errorMessage = error.message;

            showModalMessageError(errorCode);
            console.error(errorCode);
            console.error(errorMessage);
          });
        }

        function showModalMessageError(errorCode){
          var message;
            switch (errorCode) {
              case "auth/network-request-failed":
                message = "Erro na conexão! Por favor verifique sua conexão com a internet e tente novamente."
                break;
              case "auth/user-disabled":
                message = "Usuário bloqueado! Entre contato para solucionar o problema."
                break;
              case "auth/internal-error":
                message = "Ops! Encontramos um problema, tente mais uma vez. Caso o erro persista entre em contato."
                break;
              case "auth/account-exists-with-different-credential":
                message = "Uma conta já existe com o mesmo endereço de e-mail, mas credenciais de login diferentes. Faça login usando um provedor associado a este endereço de e-mail.";
                break;
              case "auth/cancelled-popup-request":
                  message = "Operação cancelada devido a outro popup conflitante que está aberto.";
                  break;
              default:
                message = "Feche para continuar!"
            }

          var p = document.getElementById("#messageModalErro");
          p.innerHTML = message;
          $("#modalErro").modal("open");
        }

        function setNameDisplay(name, url){
          var userDisplay = document.getElementById("displayName");
          var html = "<div class=\"valign-wrapper\">";
          // SE O USUÁRIO NÃO ESTIVER LOGADO É MOSTRADO UM ICONE
          // CASO CONTRÁRIO E MOSTRADO A FOTO DO USUÁRIO
          if (url == null || url == "") html += "<i class=\"material-icons left\">account_circle</i>";
          else html += "<img id=\"userPhoto\" src=\"" + url + "\" class=\"circle responsive-img\" width=\"24px\" heigth=\"24px\">"

          html += name + "<i class=\"material-icons right\">arrow_drop_down</i></div>";
          userDisplay.innerHTML = html;

          var userDisplay;
          var html = "<div class=\"valign-wrapper\">";
          // SE O USUÁRIO NÃO ESTIVER LOGADO É MOSTRADO UM ICONE
          // CASO CONTRÁRIO E MOSTRADO A FOTO DO USUÁRIO
          if (url == null || url == ""){
             html += "<i class=\"material-icons left\">account_circle</i>";
             html += "<p class=\"truncate name\">" + name + "</p><i class=\"material-icons right\">arrow_drop_down</i></div>";

             document.getElementById("displayNameMobileLogado").style.display = "none";
             document.getElementById("displayNameMobile").style.display = "block";
             userDisplay = document.getElementById("displayNameMobile");
          } else {
             html = "<div class=\"user-view\"><div class=\"background\"><img src=\"images/office.jpg\"></div>";
             html += "<a><img class=\"circle\" src=\"" + url + "\"></a>";
             html += "<span class=\"lighten-4 white-text name truncate\">" + name +"</span></div>";

             document.getElementById("displayNameMobile").style.display = "none";
             document.getElementById("displayNameMobileLogado").style.display = "block";
             userDisplay = document.getElementById("displayNameMobileLogado");
          }

          userDisplay.innerHTML = html;
        }


        //FUNÇÃO PARA EFETUAR O LOGOUT
        function logout() {
          firebase.auth().signOut().then(function() {
            // Logout efetuado com sucesso.
            //alert("Logout efetuado!");
          }).catch(function(error) {
          });
        }
      </script>
    </body>
  </html>
